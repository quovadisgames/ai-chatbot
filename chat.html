<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDT AI - Chat Interface</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600;700&family=Inter:wght@300;400;500;600;700&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Main stylesheet -->
    <link rel="stylesheet" href="styles.css">
    <!-- Theme stylesheets -->
    <link rel="stylesheet" href="themes/kotor.css">
    <link rel="stylesheet" href="themes/jedi.css">
    <link rel="stylesheet" href="themes/professional.css">
    <!-- Page-specific styles -->
    <link rel="stylesheet" href="styles/chat-page.css">
</head>
<body class="jedi-theme">
    <div class="main-container">
        <!-- Background Elements -->
        <div class="neural-grid"></div>
        <div id="neural-nodes"></div>
        <div class="particles" id="particles"></div>
        <div class="waves-container" id="waves-container"></div>
        
        <!-- Navigation Bar -->
        <div class="nav-container">
            <!-- Navigation Links -->
            <a href="index.html" class="back-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                Back to Home
            </a>
            
            <a href="participants.html" class="personas-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                View Personas
            </a>
            
            <!-- Theme Switcher -->
            <div class="theme-switcher">
                <button class="theme-switcher-button">
                    <span class="current-theme">Jedi: Survivor</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                </button>
                <div class="theme-switcher-dropdown">
                    <div class="theme-option" data-theme="kotor">KOTOR</div>
                    <div class="theme-option" data-theme="jedi">Jedi: Survivor</div>
                    <div class="theme-option" data-theme="professional">Professional</div>
                </div>
            </div>
        </div>
        
        <!-- Main Chat Layout -->
        <div class="chat-layout">
            <!-- Left Sidebar - Chat History -->
            <div class="sidebar history-sidebar">
                <div class="sidebar-header">
                    <h2 class="sidebar-title">Chat History</h2>
                    <button class="sidebar-toggle" aria-label="Toggle history sidebar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                </div>
                
                <div class="sidebar-search">
                    <input type="text" class="search-input" placeholder="Search chats...">
                </div>
                
                <div class="chat-history-list">
                    <div class="chat-history-item">
                        <div class="chat-history-title">Mission: Query #1</div>
                        <div class="chat-history-date">2025-03-11</div>
                        <div class="chat-history-preview">Neural network optimization parameters...</div>
                    </div>
                    <div class="chat-history-item">
                        <div class="chat-history-title">Mission: Data Analysis</div>
                        <div class="chat-history-date">2025-03-10</div>
                        <div class="chat-history-preview">Analyzing the latest dataset from...</div>
                    </div>
                    <div class="chat-history-item">
                        <div class="chat-history-title">Mission: Code Review</div>
                        <div class="chat-history-date">2025-03-09</div>
                        <div class="chat-history-preview">Reviewing the implementation of...</div>
                    </div>
                </div>
                
                <div class="sidebar-footer">
                    <button class="new-chat-button">
                        <span class="icon">+</span> New Chat
                    </button>
                </div>
            </div>
            
            <!-- Main Chat Container -->
            <div class="chat-container">
                <!-- Persistent Sidebar Toggle Buttons -->
                <button class="persistent-toggle history-toggle" aria-label="Toggle history sidebar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                </button>
                <button class="persistent-toggle personas-toggle" aria-label="Toggle personas sidebar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                </button>
                
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="chat-info">
                        <h1 class="chat-title">Mission: Query #1</h1>
                        <div class="chat-subtitle">
                            2 participants in this chat
                        </div>
                    </div>
                    
                    <div class="chat-actions">
                        <button class="chat-action-button rules-button" aria-label="Chat Rules">
                            <span class="icon">⚙️</span>
                            <span class="label">Rules</span>
                        </button>
                        
                        <div class="token-display">
                            <div class="token-label">Tokens</div>
                            <div class="token-bar-container">
                                <div class="token-bar-fill" style="width: 20%; background-color: var(--current-accent)"></div>
                            </div>
                            <div class="token-count">50 / 250</div>
                        </div>
                        
                        <div class="xp-display">
                            <div class="xp-rank">Padawan</div>
                            <div class="xp-bar-container">
                                <div class="xp-bar-fill" style="width: 45%"></div>
                            </div>
                            <div class="xp-points">45 XP</div>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Rules Modal (hidden by default) -->
                <div class="chat-rules-modal" style="display: none;">
                    <div class="chat-rules-header">
                        <h3>Chat Rules</h3>
                        <button class="close-button" aria-label="Close rules">×</button>
                    </div>
                    
                    <div class="chat-rules-content">
                        <div class="rule-group">
                            <label>Response Length:</label>
                            <div class="rule-options">
                                <button class="rule-option">Short</button>
                                <button class="rule-option selected">Medium</button>
                                <button class="rule-option">Long</button>
                            </div>
                        </div>
                        
                        <div class="rule-group">
                            <label>Tone:</label>
                            <div class="rule-options">
                                <button class="rule-option">Casual</button>
                                <button class="rule-option selected">Formal</button>
                                <button class="rule-option">Technical</button>
                            </div>
                        </div>
                        
                        <div class="rule-group">
                            <label>Creativity: 70%</label>
                            <input type="range" min="0" max="100" value="70" class="creativity-slider">
                        </div>
                    </div>
                    
                    <div class="chat-rules-footer">
                        <button class="apply-button">Apply Rules</button>
                    </div>
                </div>
                
                <!-- Chat Messages -->
                <div class="messages-container" id="drop-target">
                    <div class="messages-scroll-area">
                        <!-- System Message -->
                        <div class="message system">
                            <div class="system-message">
                                Mission initialized. PDT AI is ready to assist with your query.
                            </div>
                        </div>
                        
                        <!-- User Message -->
                        <div class="message user">
                            <div class="message-avatar">
                                <div class="user-avatar">U</div>
                            </div>
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="message-sender">You</span>
                                    <span class="message-time">09:16</span>
                                </div>
                                <div class="message-text">
                                    I need to optimize the neural network parameters for our latest model. The current configuration is using too much memory and the training time is excessive. Can you suggest some optimizations?
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI Message -->
                        <div class="message assistant">
                            <div class="message-avatar">
                                <div class="ai-avatar">
                                    <img src="/avatars/jedi-master.png" alt="Jedi Master Zex" class="avatar-image">
                                </div>
                            </div>
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="message-sender">Jedi Master Zex</span>
                                    <span class="message-time">09:17</span>
                                </div>
                                <div class="message-text">
                                    <p>Based on your description, there are several optimization strategies we can implement:</p>
                                    <ol>
                                        <li>
                                            <strong>Reduce batch size</strong>: This will decrease memory usage but may increase training time. Finding the optimal batch size is crucial.
                                        </li>
                                        <li>
                                            <strong>Mixed precision training</strong>: Using FP16 instead of FP32 can significantly reduce memory usage and speed up training on compatible hardware.
                                        </li>
                                        <li>
                                            <strong>Model pruning</strong>: Remove unnecessary connections in your neural network without significant accuracy loss.
                                        </li>
                                        <li>
                                            <strong>Knowledge distillation</strong>: Train a smaller "student" model to mimic a larger "teacher" model.
                                        </li>
                                    </ol>
                                    <p>Would you like me to elaborate on any of these approaches?</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- User Message -->
                        <div class="message user">
                            <div class="message-avatar">
                                <div class="user-avatar">U</div>
                            </div>
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="message-sender">You</span>
                                    <span class="message-time">09:19</span>
                                </div>
                                <div class="message-text">
                                    I'd like to know more about mixed precision training. How much memory savings can we expect, and are there any drawbacks?
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI Message with Code -->
                        <div class="message assistant">
                            <div class="message-avatar">
                                <div class="ai-avatar">
                                    <img src="/avatars/jedi-master.png" alt="Jedi Master Zex" class="avatar-image">
                                </div>
                            </div>
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="message-sender">Jedi Master Zex</span>
                                    <span class="message-time">09:21</span>
                                </div>
                                <div class="message-text">
                                    <p>Mixed precision training can reduce memory usage by up to 50% while potentially increasing training speed by 2-3x on hardware with tensor cores (like NVIDIA's Volta, Turing, and Ampere architectures).</p>
                                    
                                    <p><strong>Benefits:</strong></p>
                                    <ul>
                                        <li>Reduced memory usage (almost half)</li>
                                        <li>Faster computation and training times</li>
                                        <li>Allows for larger batch sizes or model sizes</li>
                                    </ul>
                                    
                                    <p><strong>Drawbacks:</strong></p>
                                    <ul>
                                        <li>Potential for numerical instability (mitigated with loss scaling)</li>
                                        <li>Not all operations support FP16</li>
                                        <li>Requires compatible hardware for speed benefits</li>
                                    </ul>
                                    
                                    <p>Here's a simple implementation example using PyTorch's automatic mixed precision:</p>
                                    
                                    <pre><code class="language-python"># Import the necessary libraries
from torch.cuda.amp import autocast, GradScaler

# Initialize the model, optimizer, data loader
model = YourModel().cuda()
optimizer = torch.optim.Adam(model.parameters(), lr=1e-3)
train_loader = DataLoader(dataset, batch_size=32)

# Initialize the gradient scaler
scaler = GradScaler()

# Training loop
for epoch in range(num_epochs):
    for inputs, targets in train_loader:
        inputs, targets = inputs.cuda(), targets.cuda()
        
        # Forward pass with autocast
        with autocast():
            outputs = model(inputs)
            loss = loss_fn(outputs, targets)
        
        # Backward pass with gradient scaling
        optimizer.zero_grad()
        scaler.scale(loss).backward()
        scaler.step(optimizer)
        scaler.update()</code></pre>
                                    
                                    <p>This implementation automatically handles the conversion between FP32 and FP16 where appropriate, and the gradient scaler helps prevent underflow in the gradients.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Loading Message (when AI is typing) -->
                        <div class="message assistant loading" style="display: none;">
                            <div class="message-avatar">
                                <div class="ai-avatar">
                                    <img src="/avatars/jedi-master.png" alt="Jedi Master Zex" class="avatar-image">
                                </div>
                            </div>
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="message-sender">Jedi Master Zex</span>
                                    <span class="message-time">09:22</span>
                                </div>
                                <div class="typing-indicator">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Input -->
                <div class="chat-input-container">
                    <form class="chat-form">
                        <div class="participants-chips">
                            <div class="participant-chip">
                                <img src="/avatars/jedi-master.png" alt="Jedi Master Zex" class="chip-avatar">
                                <span class="chip-name">Jedi Master Zex</span>
                            </div>
                            <div class="participant-chip">
                                <img src="/avatars/agent.png" alt="Agent PD-7" class="chip-avatar">
                                <span class="chip-name">Agent PD-7</span>
                                <button type="button" class="chip-remove" aria-label="Remove Agent PD-7">×</button>
                            </div>
                        </div>
                        
                        <div class="input-row">
                            <textarea class="chat-input" placeholder="Message Jedi Master Zex..." rows="1"></textarea>
                            
                            <div class="input-actions">
                                <button type="button" class="stop-button" style="display: none;">Stop</button>
                                <button type="submit" class="send-button" disabled>Send</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Right Sidebar - Personas -->
            <div class="sidebar personas-sidebar">
                <div class="sidebar-header">
                    <h2 class="sidebar-title">Personas</h2>
                    <button class="sidebar-toggle" aria-label="Toggle personas sidebar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                    </button>
                </div>
                
                <div class="sidebar-search">
                    <input type="text" class="search-input" placeholder="Search personas...">
                </div>
                
                <div class="personas-list">
                    <div class="persona-card" draggable="true">
                        <div class="persona-avatar">
                            <img src="/avatars/jedi-master.png" alt="Jedi Master Zex" class="avatar-image">
                        </div>
                        
                        <div class="persona-info">
                            <div class="persona-name">Jedi Master Zex</div>
                            <div class="persona-role">Mentor</div>
                            <div class="persona-response-time">
                                <span class="response-label">Response:</span>
                                <span class="response-value medium">Medium</span>
                            </div>
                        </div>
                        
                        <div class="persona-actions">
                            <button class="add-persona-button">Add</button>
                        </div>
                    </div>
                    
                    <div class="persona-card" draggable="true">
                        <div class="persona-avatar">
                            <img src="/avatars/agent.png" alt="Agent PD-7" class="avatar-image">
                        </div>
                        
                        <div class="persona-info">
                            <div class="persona-name">Agent PD-7</div>
                            <div class="persona-role">Scout</div>
                            <div class="persona-response-time">
                                <span class="response-label">Response:</span>
                                <span class="response-value fast">Fast</span>
                            </div>
                        </div>
                        
                        <div class="persona-actions">
                            <button class="add-persona-button">Add</button>
                        </div>
                    </div>
                    
                    <div class="persona-card" draggable="true">
                        <div class="persona-avatar">
                            <img src="/avatars/support.png" alt="Support Bot" class="avatar-image">
                        </div>
                        
                        <div class="persona-info">
                            <div class="persona-name">Support Bot</div>
                            <div class="persona-role">Engineer</div>
                            <div class="persona-response-time">
                                <span class="response-label">Response:</span>
                                <span class="response-value slow">Slow</span>
                            </div>
                        </div>
                        
                        <div class="persona-actions">
                            <button class="add-persona-button">Add</button>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-footer">
                    <button class="create-persona-button">
                        <span class="icon">+</span> Create Persona
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Theme Switcher Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const themeSwitcher = document.querySelector('.theme-switcher');
            const themeSwitcherButton = document.querySelector('.theme-switcher-button');
            const themeOptions = document.querySelectorAll('.theme-option');
            const currentThemeSpan = document.querySelector('.current-theme');
            
            // Toggle theme dropdown
            themeSwitcherButton.addEventListener('click', function() {
                themeSwitcher.classList.toggle('active');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                if (!themeSwitcher.contains(event.target)) {
                    themeSwitcher.classList.remove('active');
                }
            });
            
            // Theme selection
            themeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const theme = this.getAttribute('data-theme');
                    document.body.className = theme + '-theme';
                    
                    // Update current theme text
                    if (theme === 'kotor') {
                        currentThemeSpan.textContent = 'KOTOR';
                    } else if (theme === 'jedi') {
                        currentThemeSpan.textContent = 'Jedi: Survivor';
                    } else if (theme === 'professional') {
                        currentThemeSpan.textContent = 'Professional';
                    }
                    
                    // Save theme preference
                    localStorage.setItem('pdtAiTheme', theme);
                    
                    // Close dropdown
                    themeSwitcher.classList.remove('active');
                });
            });
            
            // Load saved theme
            const savedTheme = localStorage.getItem('pdtAiTheme');
            if (savedTheme) {
                document.body.className = savedTheme + '-theme';
                
                // Update current theme text
                if (savedTheme === 'kotor') {
                    currentThemeSpan.textContent = 'KOTOR';
                } else if (savedTheme === 'jedi') {
                    currentThemeSpan.textContent = 'Jedi: Survivor';
                } else if (savedTheme === 'professional') {
                    currentThemeSpan.textContent = 'Professional';
                }
            }
            
            // Chat Rules Modal Functionality
            const rulesButton = document.querySelector('.rules-button');
            const chatRulesModal = document.querySelector('.chat-rules-modal');
            const closeButton = document.querySelector('.close-button');
            const applyButton = document.querySelector('.apply-button');
            const ruleOptions = document.querySelectorAll('.rule-option');
            const creativitySlider = document.querySelector('.creativity-slider');
            
            // Toggle rules modal
            rulesButton.addEventListener('click', function() {
                chatRulesModal.style.display = chatRulesModal.style.display === 'none' ? 'block' : 'none';
            });
            
            // Close modal
            closeButton.addEventListener('click', function() {
                chatRulesModal.style.display = 'none';
            });
            
            // Apply rules
            applyButton.addEventListener('click', function() {
                chatRulesModal.style.display = 'none';
                // In a real app, this would apply the selected rules
            });
            
            // Rule option selection
            ruleOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selected class from siblings
                    const siblings = Array.from(this.parentNode.children);
                    siblings.forEach(sibling => sibling.classList.remove('selected'));
                    
                    // Add selected class to clicked option
                    this.classList.add('selected');
                });
            });
            
            // Creativity slider
            creativitySlider.addEventListener('input', function() {
                const value = this.value;
                this.parentNode.querySelector('label').textContent = `Creativity: ${value}%`;
            });
        });

        // Chat Input Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.querySelector('.chat-input');
            const sendButton = document.querySelector('.send-button');
            const stopButton = document.querySelector('.stop-button');
            const messagesScrollArea = document.querySelector('.messages-scroll-area');
            const chatForm = document.querySelector('.chat-form');
            const messagesContainer = document.querySelector('.messages-container');
            
            // Auto-resize textarea
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                
                // Enable/disable send button based on input
                if (this.value.trim().length > 0) {
                    sendButton.removeAttribute('disabled');
                } else {
                    sendButton.setAttribute('disabled', true);
                }
            });
            
            // Send message on form submit
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();
                if (!sendButton.hasAttribute('disabled')) {
                    sendMessage();
                }
            });
            
            // Send message on Enter key (but allow Shift+Enter for new line)
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!sendButton.hasAttribute('disabled')) {
                        sendMessage();
                    }
                }
            });
            
            // Stop button functionality
            stopButton.addEventListener('click', function() {
                const loadingMessage = document.querySelector('.message.assistant.loading');
                if (loadingMessage) {
                    loadingMessage.style.display = 'none';
                }
                
                stopButton.style.display = 'none';
                sendButton.style.display = 'block';
            });
            
            // Function to send a message
            function sendMessage() {
                const messageText = chatInput.value.trim();
                if (messageText.length === 0) return;
                
                // Create user message element
                const userMessage = document.createElement('div');
                userMessage.className = 'message user';
                userMessage.innerHTML = `
                    <div class="message-avatar">
                        <div class="user-avatar">U</div>
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">You</span>
                            <span class="message-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                        </div>
                        <div class="message-text">
                            ${messageText.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                `;
                
                // Add user message to chat
                messagesScrollArea.appendChild(userMessage);
                
                // Clear input and reset height
                chatInput.value = '';
                chatInput.style.height = 'auto';
                sendButton.setAttribute('disabled', true);
                
                // Show typing indicator
                const loadingMessage = document.querySelector('.message.assistant.loading');
                loadingMessage.style.display = 'flex';
                
                // Show stop button, hide send button
                stopButton.style.display = 'block';
                sendButton.style.display = 'none';
                
                // Scroll to bottom
                scrollToBottom();
                
                // Simulate AI response after a delay
                setTimeout(() => {
                    // Hide typing indicator
                    loadingMessage.style.display = 'none';
                    
                    // Show send button, hide stop button
                    stopButton.style.display = 'none';
                    sendButton.style.display = 'block';
                    
                    // Create AI response
                    const aiResponse = document.createElement('div');
                    aiResponse.className = 'message assistant';
                    aiResponse.innerHTML = `
                        <div class="message-avatar">
                            <div class="ai-avatar">
                                <img src="/avatars/jedi-master.png" alt="Jedi Master Zex" class="avatar-image">
                            </div>
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">Jedi Master Zex</span>
                                <span class="message-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                            </div>
                            <div class="message-text">
                                <p>I've analyzed your request and here are my thoughts:</p>
                                <p>The approach you're describing could work, but there are some important considerations to keep in mind. The efficiency of the solution depends on several factors including the scale of data, processing requirements, and specific constraints of your environment.</p>
                                <p>Would you like me to provide a more detailed analysis or suggest some alternative approaches?</p>
                            </div>
                        </div>
                    `;
                    
                    // Add AI response to chat
                    messagesScrollArea.appendChild(aiResponse);
                    
                    // Scroll to bottom again
                    scrollToBottom();
                    
                    // Update token usage
                    updateTokenUsage();
                }, 2000);
            }
            
            // Scroll chat to bottom
            function scrollToBottom() {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            // Update token usage
            function updateTokenUsage() {
                const tokenBarFill = document.querySelector('.token-bar-fill');
                const tokenCount = document.querySelector('.token-count');
                
                // Get current width as percentage
                const currentWidth = parseFloat(tokenBarFill.style.width);
                // Add 10% for each message, max 100%
                const newWidth = Math.min(currentWidth + 10, 100);
                
                // Update width
                tokenBarFill.style.width = `${newWidth}%`;
                
                // Update color based on usage
                if (newWidth < 50) {
                    tokenBarFill.style.backgroundColor = 'var(--current-accent)';
                } else if (newWidth < 80) {
                    tokenBarFill.style.backgroundColor = 'orange';
                } else {
                    tokenBarFill.style.backgroundColor = 'red';
                }
                
                // Update count text
                const current = Math.round((newWidth / 100) * 250);
                tokenCount.textContent = `${current} / 250`;
            }
            
            // Initial scroll to bottom
            scrollToBottom();
        });

        // Sidebar Toggle Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const historySidebarToggle = document.querySelector('.history-sidebar .sidebar-toggle');
            const historySidebar = document.querySelector('.history-sidebar');
            const chatContainer = document.querySelector('.chat-container');
            
            const personasSidebarToggle = document.querySelector('.personas-sidebar .sidebar-toggle');
            const personasSidebar = document.querySelector('.personas-sidebar');
            
            // Persistent toggle buttons
            const historyPersistentToggle = document.querySelector('.persistent-toggle.history-toggle');
            const personasPersistentToggle = document.querySelector('.persistent-toggle.personas-toggle');
            
            // Function to toggle history sidebar
            function toggleHistorySidebar() {
                historySidebar.classList.toggle('collapsed');
                chatContainer.classList.toggle('history-collapsed');
                
                // Force a reflow to ensure the layout updates properly
                window.dispatchEvent(new Event('resize'));
            }
            
            // Function to toggle personas sidebar
            function togglePersonasSidebar() {
                personasSidebar.classList.toggle('collapsed');
                chatContainer.classList.toggle('personas-collapsed');
                
                // Force a reflow to ensure the layout updates properly
                window.dispatchEvent(new Event('resize'));
            }
            
            // History sidebar toggle events
            historySidebarToggle.addEventListener('click', toggleHistorySidebar);
            historyPersistentToggle.addEventListener('click', toggleHistorySidebar);
            
            // Personas sidebar toggle events
            personasSidebarToggle.addEventListener('click', togglePersonasSidebar);
            personasPersistentToggle.addEventListener('click', togglePersonasSidebar);
            
            // Initial scroll to bottom of messages
            const messagesContainer = document.querySelector('.messages-container');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });

        // Drag and Drop Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const personaCards = document.querySelectorAll('.persona-card');
            const dropTarget = document.getElementById('drop-target');
            const participantsChips = document.querySelector('.participants-chips');
            
            // Drag start
            personaCards.forEach(card => {
                card.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.querySelector('.persona-name').textContent);
                    this.classList.add('dragging');
                });
                
                card.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                });
                
                // Add button click
                const addButton = card.querySelector('.add-persona-button');
                addButton.addEventListener('click', function() {
                    const personaName = card.querySelector('.persona-name').textContent;
                    const personaAvatar = card.querySelector('.avatar-image').src;
                    addPersonaToChat(personaName, personaAvatar);
                });
            });
            
            // Drop target events
            dropTarget.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('drop-active');
            });
            
            dropTarget.addEventListener('dragleave', function() {
                this.classList.remove('drop-active');
            });
            
            dropTarget.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drop-active');
                
                const personaName = e.dataTransfer.getData('text/plain');
                const personaCard = Array.from(personaCards).find(card => 
                    card.querySelector('.persona-name').textContent === personaName
                );
                
                if (personaCard) {
                    const personaAvatar = personaCard.querySelector('.avatar-image').src;
                    addPersonaToChat(personaName, personaAvatar);
                }
            });
            
            // Function to add persona to chat
            function addPersonaToChat(personaName, personaAvatar) {
                // Check if persona is already in chat
                const existingChips = Array.from(participantsChips.children);
                const alreadyExists = existingChips.some(chip => 
                    chip.querySelector('.chip-name').textContent === personaName
                );
                
                if (alreadyExists) {
                    alert(`${personaName} is already in the chat`);
                    return;
                }
                
                // Create new chip
                const newChip = document.createElement('div');
                newChip.className = 'participant-chip';
                newChip.innerHTML = `
                    <img src="${personaAvatar}" alt="${personaName}" class="chip-avatar">
                    <span class="chip-name">${personaName}</span>
                    <button type="button" class="chip-remove" aria-label="Remove ${personaName}">×</button>
                `;
                
                // Add chip to participants
                participantsChips.appendChild(newChip);
                
                // Add system message
                const systemMessage = document.createElement('div');
                systemMessage.className = 'message system';
                systemMessage.innerHTML = `
                    <div class="system-message">
                        ${personaName} has joined the chat.
                    </div>
                `;
                
                // Add system message to chat
                const messagesScrollArea = document.querySelector('.messages-scroll-area');
                messagesScrollArea.appendChild(systemMessage);
                
                // Scroll to bottom
                const messagesContainer = document.querySelector('.messages-container');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Add remove functionality to new chip
                const removeButton = newChip.querySelector('.chip-remove');
                removeButton.addEventListener('click', function() {
                    // Remove chip
                    newChip.remove();
                    
                    // Add system message for removal
                    const removeMessage = document.createElement('div');
                    removeMessage.className = 'message system';
                    removeMessage.innerHTML = `
                        <div class="system-message">
                            ${personaName} has left the chat.
                        </div>
                    `;
                    
                    // Add system message to chat
                    messagesScrollArea.appendChild(removeMessage);
                    
                    // Scroll to bottom
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
            }
            
            // Add remove functionality to existing chips
            const removeButtons = document.querySelectorAll('.chip-remove');
            removeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const chip = this.closest('.participant-chip');
                    const personaName = chip.querySelector('.chip-name').textContent;
                    
                    // Remove chip
                    chip.remove();
                    
                    // Add system message for removal
                    const removeMessage = document.createElement('div');
                    removeMessage.className = 'message system';
                    removeMessage.innerHTML = `
                        <div class="system-message">
                            ${personaName} has left the chat.
                        </div>
                    `;
                    
                    // Add system message to chat
                    const messagesScrollArea = document.querySelector('.messages-scroll-area');
                    messagesScrollArea.appendChild(removeMessage);
                    
                    // Scroll to bottom
                    const messagesContainer = document.querySelector('.messages-container');
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
            });
        });

        // Background Effects
        document.addEventListener('DOMContentLoaded', function() {
            // Neural Network Grid Nodes and Connections
            createNeuralNetwork();
            
            // Particles
            createParticles();
            
            // Waves
            createWaves();
            
            // Window resize handler
            window.addEventListener('resize', function() {
                // Clear existing elements
                document.getElementById('neural-nodes').innerHTML = '';
                document.getElementById('particles').innerHTML = '';
                
                // Recreate elements
                createNeuralNetwork();
                createParticles();
            });
            
            // Create neural network nodes and connections
            function createNeuralNetwork() {
                const nodesContainer = document.getElementById('neural-nodes');
                const width = window.innerWidth;
                const height = window.innerHeight;
                
                // Create nodes
                const nodes = [];
                const nodeCount = Math.floor(width * height / 25000); // Adjust density based on screen size
                
                for (let i = 0; i < nodeCount; i++) {
                    const node = document.createElement('div');
                    node.className = 'neural-node';
                    
                    // Random position
                    const x = Math.random() * width;
                    const y = Math.random() * height;
                    
                    node.style.left = `${x}px`;
                    node.style.top = `${y}px`;
                    
                    // Pulse animation with random delay
                    node.style.animation = `pulse 3s infinite ${Math.random() * 3}s`;
                    
                    nodesContainer.appendChild(node);
                    nodes.push({ element: node, x, y });
                }
                
                // Create connections between nearby nodes
                nodes.forEach((node, i) => {
                    // Connect to a few nearby nodes
                    for (let j = 0; j < nodes.length; j++) {
                        if (i !== j) {
                            const otherNode = nodes[j];
                            const dx = otherNode.x - node.x;
                            const dy = otherNode.y - node.y;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            
                            // Only connect if within a certain distance
                            if (distance < 150) {
                                const connection = document.createElement('div');
                                connection.className = 'neural-connection';
                                
                                // Position and rotate the connection
                                connection.style.left = `${node.x}px`;
                                connection.style.top = `${node.y}px`;
                                connection.style.width = `${distance}px`;
                                connection.style.transform = `rotate(${Math.atan2(dy, dx)}rad)`;
                                
                                // Fade based on distance
                                connection.style.opacity = 0.5 - distance / 300;
                                
                                nodesContainer.appendChild(connection);
                            }
                        }
                    }
                });
            }
            
            // Create floating particles
            function createParticles() {
                const particlesContainer = document.getElementById('particles');
                const width = window.innerWidth;
                const height = window.innerHeight;
                
                // Create particles
                const particleCount = Math.floor(width * height / 10000);
                
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    
                    // Random position
                    const x = Math.random() * width;
                    const y = Math.random() * height;
                    
                    particle.style.left = `${x}px`;
                    particle.style.top = `${y}px`;
                    
                    // Random drift direction and duration
                    const xDrift = (Math.random() - 0.5) * 200;
                    const yDrift = (Math.random() - 0.5) * 200;
                    const driftDuration = 3 + Math.random() * 7;
                    
                    particle.style.setProperty('--x-drift', `${xDrift}px`);
                    particle.style.setProperty('--y-drift', `${yDrift}px`);
                    particle.style.setProperty('--drift-duration', `${driftDuration}s`);
                    
                    // Random size
                    const size = 1 + Math.random() * 2;
                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;
                    
                    // Random opacity
                    particle.style.opacity = 0.1 + Math.random() * 0.2;
                    
                    particlesContainer.appendChild(particle);
                }
            }
            
            // Create wave elements
            function createWaves() {
                const wavesContainer = document.getElementById('waves-container');
                
                // Create three wave elements
                for (let i = 1; i <= 3; i++) {
                    const wave = document.createElement('div');
                    wave.className = `wave wave-${i}`;
                    wavesContainer.appendChild(wave);
                }
            }
        });
    </script>
</body>
</html> 